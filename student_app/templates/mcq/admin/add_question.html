{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="mb-0">
                        <i class="fas fa-plus me-2"></i>
                        Add New MCQ Question
                    </h2>
                    <p class="mb-0 mt-2">Create a new multiple choice question</p>
                </div>
                <div class="card-body p-5">
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.faculty.id_for_label }}" class="form-label">
                                            <i class="fas fa-university me-2"></i>Faculty <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            {{ form.faculty }}
                                            <button type="button" class="btn btn-outline-success" id="addQuizBtn" style="display: none;">
                                                <i class="fas fa-plus me-1"></i>Add Quiz
                                            </button>
                                        </div>
                                        {% if form.faculty.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.faculty.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="{{ form.quiz.id_for_label }}" class="form-label">
                                            <i class="fas fa-clipboard-list me-2"></i>Quiz <span class="text-danger">*</span>
                                        </label>
                                        {{ form.quiz }}
                                        {% if form.quiz.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.quiz.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Select a faculty first to see available quizzes
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.question_text.id_for_label }}" class="form-label">
                                    <i class="fas fa-question-circle me-2"></i>Question Text <span class="text-danger">*</span>
                                </label>
                                {{ form.question_text }}
                                {% if form.question_text.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.question_text.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group mb-3">
                                <div class="form-check">
                                    {{ form.published }}
                                    <label class="form-check-label" for="{{ form.published.id_for_label }}">
                                        <i class="fas fa-eye me-2"></i>Published
                                    </label>
                                </div>
                                <small class="text-muted">Only published questions are visible to students</small>
                                {% if form.published.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.published.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> After creating the question, you'll be able to add multiple options and mark one as correct.
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-save me-2"></i>
                                Create Question
                            </button>
                            <a href="{% url 'mcq_admin_dashboard' %}" class="btn btn-outline-secondary btn-lg ms-3">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.form-check-input {
    border-radius: 4px;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
}

.alert {
    border-radius: 8px;
    border: none;
}

.form-label {
    font-weight: 600;
    color: #495057;
}

.form-control, .form-select {
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.15);
}

.form-check-label {
    font-weight: 500;
    color: #495057;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const facultySelect = document.getElementById('id_faculty');
    const quizSelect = document.getElementById('id_quiz');
    
    // Function to load quizzes for a faculty
    function loadQuizzes(facultyId) {
        if (!facultyId) {
            quizSelect.innerHTML = '<option value="">Select Quiz</option>';
            return;
        }
        
        // Show loading state
        quizSelect.innerHTML = '<option value="">Loading quizzes...</option>';
        quizSelect.disabled = true;
        
        fetch(`/mcq/admin/get-quizzes/?faculty_id=${facultyId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Clear and reset quiz options
                quizSelect.innerHTML = '<option value="">Select Quiz</option>';
                
                if (data.quizzes && data.quizzes.length > 0) {
                    data.quizzes.forEach(quiz => {
                        const option = document.createElement('option');
                        option.value = quiz.id;
                        option.textContent = `Quiz ${quiz.quiz_number}: ${quiz.title}`;
                        quizSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No quizzes found for this faculty';
                    option.disabled = true;
                    quizSelect.appendChild(option);
                }
                
                quizSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error fetching quizzes:', error);
                quizSelect.innerHTML = '<option value="">Error loading quizzes</option>';
                quizSelect.disabled = false;
                
                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-2';
                errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error loading quizzes. Please try again.';
                
                // Remove any existing error messages
                const existingError = quizSelect.parentNode.querySelector('.alert-danger');
                if (existingError) {
                    existingError.remove();
                }
                
                quizSelect.parentNode.appendChild(errorDiv);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            });
    }
    
    // Handle faculty selection change
    facultySelect.addEventListener('change', function() {
        const facultyId = this.value;
        loadQuizzes(facultyId);
        
        // Show/hide Add Quiz button
        const addQuizBtn = document.getElementById('addQuizBtn');
        if (facultyId) {
            addQuizBtn.style.display = 'block';
        } else {
            addQuizBtn.style.display = 'none';
        }
    });
    
    // Handle Add Quiz button click
    document.getElementById('addQuizBtn').addEventListener('click', function() {
        const facultyId = facultySelect.value;
        if (facultyId) {
            // Open modal or redirect to add quiz page
            const quizTitle = prompt('Enter Quiz Title (optional):');
            if (quizTitle !== null) {
                // Create new quiz via AJAX
                createNewQuiz(facultyId, quizTitle);
            }
        }
    });
    
    // Function to create new quiz
    function createNewQuiz(facultyId, title) {
        fetch('/mcq/admin/create-quiz/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                faculty_id: facultyId,
                title: title || ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload quizzes list
                loadQuizzes(facultyId);
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success mt-2';
                successDiv.innerHTML = '<i class="fas fa-check me-2"></i>Quiz created successfully!';
                quizSelect.parentNode.appendChild(successDiv);
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 3000);
            } else {
                alert('Error creating quiz: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error creating quiz:', error);
            alert('Error creating quiz. Please try again.');
        });
    }
    
    // Load quizzes if faculty is already selected (for form validation errors)
    if (facultySelect.value) {
        loadQuizzes(facultySelect.value);
    }
});
</script>
{% endblock %}
